from flask import Flask, request
import os
import requests

app = Flask(__name__)

BOT_TOKEN = os.environ.get('BOT_TOKEN')
CHAT_ID = os.environ.get('CHAT_ID')

@app.route('/', methods=['POST'])
def tinkoff_webhook():
    data = request.get_json()
    print("–ü–æ–ª—É—á–µ–Ω –≤–µ–±—Ö—É–∫:", data)  # –î–ª—è –æ—Ç–ª–∞–¥–∫–∏ –≤ Render

    if not data:
        return '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö', 400

    order_id = data.get('OrderId', '‚Äî')
    amount = data.get('Amount', 0) / 100
    email = data.get('Email', '‚Äî')
    status = data.get('Status', '')
    success = data.get('Success', False)

    if success and status == 'CONFIRMED':
        message = (
            f"‚úÖ –û–ø–ª–∞—Ç–∞ –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ!\n"
            f"üßæ –ó–∞–∫–∞–∑: {order_id}\n"
            f"üí≥ –°—É–º–º–∞: {amount} ‚ÇΩ\n"
            f"üìß Email: {email}"
        )
    elif not success:
        reason = data.get('Message', '–ü—Ä–∏—á–∏–Ω–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞')
        message = (
            f"‚ùå –ü–ª–∞—Ç—ë–∂ –æ—Ç–∫–ª–æ–Ω—ë–Ω!\n"
            f"üßæ –ó–∞–∫–∞–∑: {order_id}\n"
            f"üí≥ –°—É–º–º–∞: {amount} ‚ÇΩ\n"
            f"üìß Email: {email}\n"
            f"üö´ –ü—Ä–∏—á–∏–Ω–∞: {reason}"
        )
    else:
        return '–ù–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º—ã–π —Å—Ç–∞—Ç—É—Å', 200

    # –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ Telegram
    requests.post(
        f"https://api.telegram.org/bot{BOT_TOKEN}/sendMessage",
        data={'chat_id': CHAT_ID, 'text': message}
    )

    return 'OK', 200

if __name__ == "__main__":
    app.run(host='0.0.0.0', port=int(os.environ.get('PORT', 8080)))
