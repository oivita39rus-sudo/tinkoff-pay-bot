from flask import Flask, request
import os
import requests

app = Flask(__name__)

BOT_TOKEN = os.environ.get('BOT_TOKEN')
CHAT_ID = os.environ.get('CHAT_ID')

@app.route('/', methods=['POST'])
def tinkoff_webhook():
    data = request.get_json()
    
    # üîç –û—Ç–ª–∞–¥–æ—á–Ω—ã–π –≤—ã–≤–æ–¥ –≤ –ª–æ–≥ Render
    print("[DEBUG] –ü–æ–ª—É—á–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ –æ—Ç –¢–∏–Ω—å–∫–æ—Ñ—Ñ:")
    print(data)

    if not data:
        return 'No data', 400

    order_id = data.get('OrderId', '–Ω–µ —É–∫–∞–∑–∞–Ω')
    amount = data.get('Amount', 0) / 100
    email = data.get('Email', '–Ω–µ —É–∫–∞–∑–∞–Ω')
    status = data.get('Status', 'UNKNOWN')
    success = data.get('Success', False)

    if success is True:
        message = (
            f"‚úÖ –û–ø–ª–∞—Ç–∞ –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ!\n"
            f"üßæ –ó–∞–∫–∞–∑: {order_id}\n"
            f"üí≥ –°—É–º–º–∞: {amount:.2f} ‚ÇΩ\n"
            f"üìß Email: {email}"
        )
    else:
        reason = data.get('Message') or "–ü—Ä–∏—á–∏–Ω–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞"
        message = (
            f"‚ùå –û–ø–ª–∞—Ç–∞ –Ω–µ –ø—Ä–æ—à–ª–∞!\n"
            f"üßæ –ó–∞–∫–∞–∑: {order_id}\n"
            f"üí≥ –°—É–º–º–∞: {amount:.2f} ‚ÇΩ\n"
            f"üìß Email: {email}\n"
            f"üìå –°—Ç–∞—Ç—É—Å: {status}\n"
            f"‚ö†Ô∏è –ü—Ä–∏—á–∏–Ω–∞: {reason}"
        )

    # –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ Telegram
    requests.post(
        f"https://api.telegram.org/bot{BOT_TOKEN}/sendMessage",
        data={'chat_id': CHAT_ID, 'text': message}
    )

    return 'OK', 200

if __name__ == "__main__":
    app.run(host='0.0.0.0', port=int(os.environ.get('PORT', 8080)))
